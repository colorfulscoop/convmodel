from convmodel.data import BertForPreTrainingDataset
import random

random.seed(1)


def encode(text):
    """
    Args:
        text (str):
    Returns:
        List[int]: 
    """
    return list(range(len(text)))


def test_BlockDataset():
    dataset = BertForPreTrainingDataset(
        generator=lambda: [
            "AAAAAAAAAA",
            "BBBBBBBBBBBBBBB",
            "CCCCCCCCCCCCCCCCCCCC",
        ],
        encode_fn=encode,
        sep_token_id=10000,
        cls_token_id=10001,
        mask_token_id=10002,
        random_token_ids=[100, 101, 102],
        max_seq_len=40,
    )
    got = list(iter(dataset))
    print(got)

    want = [{
        'input_ids': [
            10001, 0, 1, 2, 10002, 4, 5, 6, 7, 8, 9, 10000,
            0, 1, 2, 3, 10002, 10002, 6, 7, 8, 9, 101, 11, 12, 13, 10002, 15, 16, 17, 18, 19, 10000,
            0, 0, 0, 0, 0, 0, 0],
        'labels': [
            -100, -100, -100, -100, 3, -100, -100, -100, -100, -100, -100, -100,
            -100, -100, -100, -100, 4, 5, -100, -100, -100, -100, 10, -100, -100, -100, 14, -100, -100, -100, -100, -100, -100,
            -100, -100, -100, -100, -100, -100, -100],
        'attention_mask': [
            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
            0, 0, 0, 0, 0, 0, 0],
        'token_type_ids': [
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
            0, 0, 0, 0, 0, 0, 0],
        'next_sentence_label': 1
        },
        {
            'input_ids': [
                10001, 0, 10002, 2, 3, 4, 5, 10002, 7, 8, 9, 10, 11, 12, 10002, 14, 10000,
                0, 1, 2, 3, 100, 5, 6, 7, 8, 10002, 10, 11, 12, 13, 14, 15, 10002, 17, 18, 19, 10000,
                0, 0],
            'labels': [
                -100, -100, 1, -100, -100, -100, -100, 6, -100, -100, -100, -100, -100, -100, 13, -100, -100,
                -100, -100, -100, -100, 4, -100, -100, -100, -100, 9, -100, -100, -100, -100, -100, -100, 16, -100, -100, -100, -100,
                -100, -100],
            'attention_mask': [
                1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
                1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
                0, 0],
            'token_type_ids': [
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
                0, 0],
            'next_sentence_label': 0
        }
    ]
    assert got == want

